{ 
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "storageSyncServicesname": {
            "type": "string",
            "defaultValue": "",
            "maxLength": 25
        },
        "Location": {
            "type": "string",
            "metadata": {
                "defaultValue": ""
            }
        },
        "SyncGroupName": {
            "type": "string",
            "defaultValue":"ServerA-P01",
            "metadata": {
                "description": "The name of the storage endpoint."
            }
        },
        "serverID": {
            "type": "string",
            "defaultValue":"",
            "metadata": {
                "description": "The name of the storage endpoint."
            }
        },
        "enableServerEndpoint": {
            "type": "bool",
            "defaultValue": false
        },
         "azureFileShareName": {
            "type": "string",
             "defaultValue": " ",
            "metadata": {
                "description": "The name of the file share."
            }
        },
        "cloudendpoint": {
            "type": "string",
            "defaultValue": "bhendpoints",
            "metadata": {
                "description": "The name of the file share."
            }
        },
        "storageAccountResourceId": {
            "type": "securestring",
             "defaultValue": "",
            "metadata": {
                "description": "The storage account access key."
            }
        },
         "storageAccountTenantId": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "The storage server id."
            }
        },
        "cloudTiering": {
            "type": "string",
            "metadata": {
                "description": "descrip"
            }
        },
        "volumeFreeSpacePercent": {
            "type": "string",
            "metadata": {
                "description": "description"
            }
        },
        "serverLocalPath": {
            "type": "string",
            "metadata": {
                "description": "description"
            }
        },
        "Datepolicy": {
            "type": "string",
            "metadata": {
                "description": "description"
            }
        }
    },
    "variables": {
    },
    "resources": [
        {
            "type": "Microsoft.StorageSync/storageSyncServices",
            "apiVersion": "2022-06-01",
            "name": "[parameters('storageSyncServicesname')]",
            "location": "[parameters('Location')]",
            "properties": {
                "incomingTrafficPolicy": "AllowAllTraffic"
            }
        },
        {
            "type": "Microsoft.StorageSync/storageSyncServices/syncGroups",
            "apiVersion": "2022-06-01",
            "name": "[concat(parameters('storageSyncServicesname'), '/', if(not(empty(parameters('SyncGroupName'))), parameters('SyncGroupName'), 'defaultValue'))]",
            "dependsOn": [
                 "[resourceId('Microsoft.StorageSync/storageSyncServices', parameters('storageSyncServicesname'))]"
                // "[resourceId('Microsoft.Resources/deployments', 'StorageAccount')]"

            ],
            "properties": {}
        },
        {
            "condition": "[parameters('enableServerEndpoint')]",
            "type": "Microsoft.StorageSync/storageSyncServices/syncGroups/cloudEndpoints",
            "apiVersion": "2022-06-01",
            "name": "[concat(parameters('storageSyncServicesname'), '/', parameters('SyncGroupName'), '/', parameters('cloudendpoint'))]",
            "dependsOn": [
                "[resourceId('Microsoft.StorageSync/storageSyncServices', parameters('storageSyncServicesname'))]",
                "[resourceId('Microsoft.StorageSync/storageSyncServices/syncGroups', parameters('storageSyncServicesname'), parameters('SyncGroupName'))]"
            ],
            "properties": {
                "storageAccountResourceId": "[reference('linkedTemplate1').outputs.storageAccountResourceId.value]",
                "azureFileShareName": "[parameters('azureFileShareName')]",
                "storageAccountTenantId": "[parameters('storageAccountTenantId')]",
                "friendlyName": "[parameters('azureFileShareName')]"
            }
        },
        {
            "condition": "[parameters('enableServerEndpoint')]",
            "type": "Microsoft.StorageSync/storageSyncServices/syncGroups/serverEndpoints",
            "apiVersion": "2019-02-01",
            "name": "[concat(parameters('storageSyncServicesname'), '/', parameters('SyncGroupName'), '/', parameters('azureFileShareName'))]",
            "dependsOn": [
                "[resourceId('Microsoft.StorageSync/storageSyncServices', parameters('storageSyncServicesname'))]",
                "[resourceId('Microsoft.StorageSync/storageSyncServices/syncGroups/cloudEndpoints', parameters('storageSyncServicesname'), parameters('SyncGroupName'), parameters('cloudendpoint'))]"
            ],
            "properties": {
            "serverLocalPath": "[parameters('serverLocalPath')]",
            "cloudTiering": "[parameters('cloudTiering')]",
            "volumeFreeSpacePercent": "[parameters('volumeFreeSpacePercent')]",
            "tierFilesOlderThanDays": "[parameters('Datepolicy')]",
            "storageAccountResourceId":"[reference('linkedTemplate1').outputs.storageAccountResourceId.value]",
            "serverResourceId": "[resourceId('Microsoft.StorageSync/storageSyncServices/registeredServers', parameters('storageSyncServicesname'), parameters('serverID'))]",
            "offlineDataTransfer": "Off",
            "initialDownloadPolicy": "NamespaceOnly",
            "localCacheMode": "UpdateLocallyCachedFiles",
            "initialUploadPolicy": "ServerAuthoritative"
        }
    }
   ]
}

   
  


